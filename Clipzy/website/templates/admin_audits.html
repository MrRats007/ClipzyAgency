{# templates/admin_audits.html #}
{% extends "base.html" %}
{% block title %}Audit Requests{% endblock %}

{% block extra_head %}
<style>
  .admin-header{
    padding: 28px 0 10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 12px;
    flex-wrap: wrap;
  }
  .admin-header h1{
    margin: 0;
    font-size: 24px;
    letter-spacing: -0.02em;
  }
  .admin-header p{
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 14px;
  }
  .admin-actions{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items:center;
  }

  .toolbar{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap: wrap;
    margin: 10px 0 14px;
  }

  .chips{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items:center;
  }
  .chip{
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.02);
    color: var(--muted);
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: transform .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
  }
  .chip:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.14);
    color: var(--text);
    background: rgba(255,255,255,.03);
  }
  .chip.active{
    color: var(--text);
    border-color: rgba(109,94,252,.55);
    background: rgba(109,94,252,.12);
  }

  .search{
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap: wrap;
  }
  .search input{
    width: min(420px, 100%);
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.02);
    color: var(--text);
    outline:none;
  }
  .search input:focus{
    border-color: rgba(109,94,252,.65);
    background: rgba(255,255,255,.03);
  }

  .table-card{
    border-radius: calc(var(--radius) + 6px);
    border: 1px solid var(--border);
    background: rgba(255,255,255,.02);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .table-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    padding: 14px 14px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.015);
  }
  .table-head strong{
    font-size: 14px;
    letter-spacing: -0.01em;
  }
  .count{
    color: var(--muted);
    font-size: 13px;
  }

  table{
    width: 100%;
    border-collapse: collapse;
  }
  th, td{
    padding: 12px 14px;
    text-align:left;
    border-bottom: 1px solid rgba(255,255,255,.06);
    font-size: 14px;
    vertical-align: top;
  }
  th{
    color: rgba(167,179,204,.92);
    font-weight: 800;
    font-size: 12px;
    letter-spacing: .08em;
    text-transform: uppercase;
    background: rgba(255,255,255,.01);
  }
  td{
    color: rgba(234,240,255,.92);
  }
  .muted{ color: var(--muted); font-size: 13px; }
  .row-link{
    display:inline-flex;
    gap: 8px;
    align-items:center;
    font-weight: 750;
    color: var(--text);
  }
  .row-link:hover{ text-decoration: underline; }

  .status{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.02);
    color: var(--muted);
    font-weight: 800;
    font-size: 12px;
    white-space: nowrap;
  }
  .s-dot{ width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.25); }

  /* Quick colors for status dots */
  .status[data-s="New"] .s-dot{ background: rgba(109,94,252,.9); box-shadow: 0 0 0 4px rgba(109,94,252,.18); }
  .status[data-s="Contacted"] .s-dot{ background: rgba(43,231,165,.9); box-shadow: 0 0 0 4px rgba(43,231,165,.14); }
  .status[data-s="Qualified"] .s-dot{ background: rgba(255,193,7,.9); box-shadow: 0 0 0 4px rgba(255,193,7,.14); }
  .status[data-s="Closed"] .s-dot{ background: rgba(255,90,90,.9); box-shadow: 0 0 0 4px rgba(255,90,90,.14); }

  .empty{
    padding: 18px 14px;
    color: var(--muted);
  }

  /* Mobile table -> stacked rows */
  @media (max-width: 840px){
    table, thead, tbody, th, td, tr { display:block; }
    thead{ display:none; }
    tr{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 10px 0;
    }
    td{
      border: 0;
      padding: 8px 14px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
    }
    td::before{
      content: attr(data-label);
      color: rgba(167,179,204,.92);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 800;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
  <div>
    <h1>Audit Requests</h1>
    <p>All “Free Audit” submissions. Click a lead to view details and add notes.</p>
  </div>

    <div class="admin-actions">
        <a class="btn btn-ghost" href="{{ url_for('views.home') }}">Open site</a>

        <a class="btn btn-primary" href="{{ url_for('auth.logout') }}">
            Logout
        </a>
    </div>
</div>

<div class="toolbar">
  <div class="chips" aria-label="Status filters">
    {# active_status can be None or "New"/"Contacted"/"Qualified"/"Closed" #}
    <a class="chip {% if not active_status %}active{% endif %}" href="{{ url_for('auth.audits') }}">All</a>
    <a class="chip {% if active_status=='New' %}active{% endif %}" href="{{ url_for('auth.audits', status='New') }}">New</a>
    <a class="chip {% if active_status=='Contacted' %}active{% endif %}" href="{{ url_for('auth.audits', status='Contacted') }}">Contacted</a>
    <a class="chip {% if active_status=='Qualified' %}active{% endif %}" href="{{ url_for('auth.audits', status='Qualified') }}">Qualified</a>
    <a class="chip {% if active_status=='Closed' %}active{% endif %}" href="{{ url_for('auth.audits', status='Closed') }}">Closed</a>
  </div>

  <div class="search">
    <input id="searchBox" type="text" placeholder="Search name, email, brand, handle..." />
    <button class="btn btn-ghost" type="button" id="clearBtn">Clear</button>
  </div>
</div>

<div class="table-card">
  <div class="table-head">
    <strong>Leads</strong>
    <div class="count">{{ audits|length }} total</div>
  </div>

  {% if audits and audits|length > 0 %}
  <table id="leadsTable" aria-label="Audit requests table">
    <thead>
      <tr>
        <th>Lead</th>
        <th>Brand / Handle</th>
        <th>Service</th>
        <th>Status</th>
        <th>Submitted</th>
      </tr>
    </thead>
    <tbody>
      {% for a in audits %}
      <tr class="lead-row">
        <td data-label="Lead">
          <a class="row-link" href="{{ url_for('auth.audit_detail', audit_id=a.id) }}">
            {{ a.name }}
          </a>
          <div class="muted">{{ a.email }}{% if a.phone %} • {{ a.phone }}{% endif %}</div>
        </td>

        <td data-label="Brand / Handle">
          <div><strong>{{ a.brand or "—" }}</strong></div>
          <div class="muted">
            {{ a.ig_handle or "—" }}
            {% if a.website %}
              • <span class="muted">{{ a.website }}</span>
            {% endif %}
          </div>
        </td>

        <td data-label="Service">
          <div>{{ a.services or "—" }}</div>
          <div class="muted">{{ a.budget or "" }}</div>
        </td>

        <td data-label="Status">
          <span class="status" data-s="{{ a.status or 'New' }}">
            <span class="s-dot" aria-hidden="true"></span>
            {{ a.status or "New" }}
          </span>
        </td>

        <td data-label="Submitted">
          <div class="muted">
            {% if a.created_at %}{{ a.created_at.strftime("%b %d, %Y • %I:%M %p") }}{% else %}—{% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="empty">No audit requests yet.</div>
  {% endif %}
</div>

<script>
  // Simple client-side search (no backend required)
  (function(){
    const input = document.getElementById("searchBox");
    const clearBtn = document.getElementById("clearBtn");
    const table = document.getElementById("leadsTable");
    if (!input || !table) return;

    const rows = Array.from(table.querySelectorAll("tbody tr"));

    function apply(){
      const q = input.value.trim().toLowerCase();
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.includes(q) ? "" : "none";
      });
    }

    input.addEventListener("input", apply);
    clearBtn.addEventListener("click", () => {
      input.value = "";
      apply();
      input.focus();
    });
  })();
</script>
{% endblock %}